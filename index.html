<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDN Manager - OVN/OVS</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --sidebar-active: #3498db;
            --header-height: 60px;
            --horizon-blue: #006fb8;
            --horizon-grey: #f5f5f5;
        }

        body {
            font-family: "Open Sans", Helvetica, Arial, sans-serif;
            background-color: var(--horizon-grey);
            overflow-x: hidden;
        }

        /* Top Navbar */
        .navbar-horizon {
            background-color: #fff;
            border-bottom: 2px solid #e5e5e5;
            height: var(--header-height);
            position: fixed;
            width: 100%;
            z-index: 1000;
            padding: 0 20px;
        }

        .navbar-brand {
            font-weight: 700;
            color: #333;
            letter-spacing: 1px;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: var(--header-height);
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: var(--sidebar-bg);
            width: 240px;
            transition: all 0.3s;
        }

        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - var(--header-height));
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .nav-link {
            font-weight: 500;
            color: #bdc3c7;
            padding: 12px 20px;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .nav-link:hover {
            color: #fff;
            background-color: var(--sidebar-hover);
        }

        .nav-link.active {
            color: #fff;
            background-color: var(--sidebar-hover);
            border-left-color: var(--sidebar-active);
        }

        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: 240px;
            padding-top: calc(var(--header-height) + 20px);
            padding-left: 30px;
            padding-right: 30px;
            transition: all 0.3s;
        }

        .page-header {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        /* Tables mimicking Horizon */
        .table-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
        }

        .table thead th {
            border-bottom: 2px solid #ddd;
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .btn-horizon-primary {
            background-color: var(--horizon-blue);
            color: white;
            border: none;
        }
        .btn-horizon-primary:hover {
            background-color: #005a96;
            color: white;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active { background-color: #2ecc71; }
        .status-down { background-color: #e74c3c; }

        /* Overview Cards */
        .overview-card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .overview-icon {
            font-size: 2.5rem;
            opacity: 0.2;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        .card-stat {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { margin-left: -240px; }
            .sidebar.active { margin-left: 0; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-horizon d-flex justify-content-between">
        <div class="d-flex align-items-center">
            <button class="btn btn-link d-md-none me-3" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            <a class="navbar-brand" href="#">
                <i class="fas fa-network-wired me-2"></i>SDN MANAGER
            </a>
            <!-- Display current API connection for debugging -->
            <span class="badge bg-light text-dark ms-3 border d-none d-md-inline-block">API: <span id="api-target-display">Connecting...</span></span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" id="userMenu" data-bs-toggle="dropdown">
                    <i class="fas fa-user-circle me-1"></i> Admin
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="toggleDemoMode()">Toggle Demo Mode</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#">Sign Out</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-sticky">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('overview')">
                        <i class="fas fa-tachometer-alt"></i> Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="showSection('switches')">
                        <i class="fas fa-random"></i> Logical Switches
                    </a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('routers')">
                        <i class="fas fa-route"></i> Logical Routers
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="showSection('acl')">
                        <i class="fas fa-shield-alt"></i> Network ACLs
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Alert Box -->
        <div id="alert-area"></div>

        <!-- Overview Section -->
        <div id="section-overview" style="display: none;">
            <div class="page-header">
                <h2>System Overview</h2>
            </div>
            
            <div class="row g-4 mb-4">
                <!-- Status Card -->
                <div class="col-md-4">
                    <div class="card overview-card h-100 border-start border-4 border-success">
                        <div class="card-body">
                            <h5 class="card-title text-muted text-uppercase small">System Status</h5>
                            <div class="d-flex align-items-center mt-2">
                                <div id="health-indicator" class="status-dot status-active" style="width: 15px; height: 15px;"></div>
                                <span class="ms-2 fw-bold" id="health-text">Checking...</span>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Connected to: <span id="db-name">-</span></p>
                            <i class="fas fa-server overview-icon text-success"></i>
                        </div>
                    </div>
                </div>

                <!-- Switches Card -->
                <div class="col-md-4">
                    <div class="card overview-card h-100 border-start border-4 border-primary">
                        <div class="card-body">
                            <h5 class="card-title text-muted text-uppercase small">Logical Switches</h5>
                            <div class="card-stat" id="overview-switch-count">-</div>
                            <a href="#" onclick="showSection('switches')" class="text-decoration-none small">Manage Switches &rarr;</a>
                            <i class="fas fa-random overview-icon text-primary"></i>
                        </div>
                    </div>
                </div>

                <!-- Routers Card -->
                <div class="col-md-4">
                    <div class="card overview-card h-100 border-start border-4 border-warning">
                        <div class="card-body">
                            <h5 class="card-title text-muted text-uppercase small">Logical Routers</h5>
                            <div class="card-stat" id="overview-router-count">-</div>
                            <a href="#" onclick="showSection('routers')" class="text-decoration-none small">Manage Routers &rarr;</a>
                            <i class="fas fa-route overview-icon text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">Quick Actions</h6>
                        </div>
                        <div class="list-group list-group-flush">
                            <button class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#createSwitchModal">
                                <i class="fas fa-plus-circle text-primary me-2"></i> Create New Switch
                            </button>
                            <button class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#createRouterModal">
                                <i class="fas fa-plus-circle text-warning me-2"></i> Create New Router
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="fetchHealth()">
                                <i class="fas fa-sync text-secondary me-2"></i> Refresh System Status
                            </button>
                        </div>
                    </div>
                </div>
                 <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">Backend Info</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>API Endpoint:</strong> <span class="font-monospace bg-light p-1" id="overview-api-url"></span></p>
                            <p class="text-muted small">
                                OVN (Open Virtual Network) is a system to support virtual network abstraction. 
                                Use the sidebar to manage your Logical Switches, Ports, and ACLs.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Switches Section -->
        <div id="section-switches" style="display: none;">
            <div class="page-header d-flex justify-content-between align-items-center">
                <h2>Logical Switches</h2>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <h5 class="m-0">Switches</h5>
                    <div>
                        <button class="btn btn-horizon-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createSwitchModal">
                            <i class="fas fa-plus"></i> Create Switch
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedSwitches()">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0" id="switches-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllSwitches"></th>
                                <th>Name</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="switches-tbody">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ports Section (Contextual for Switch) -->
        <div id="section-ports" style="display: none;">
            <div class="page-header">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm me-3" onclick="showSection('switches')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 class="m-0">Manage Ports: <span id="current-switch-name" class="text-primary"></span></h2>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <h5 class="m-0">Logical Ports</h5>
                    <button class="btn btn-horizon-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createPortModal">
                        <i class="fas fa-plus"></i> Create Port
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Port Name</th>
                                <th>Addresses</th>
                                <th>VLAN Tag</th>
                                <th>Trunks</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ports-tbody">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Routers Section -->
        <div id="section-routers" style="display: none;">
            <div class="page-header d-flex justify-content-between align-items-center">
                <h2>Logical Routers</h2>
            </div>
            
            <div class="table-card">
                <div class="table-header">
                    <h5 class="m-0">Routers</h5>
                    <div>
                        <button class="btn btn-horizon-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRouterModal">
                            <i class="fas fa-plus"></i> Create Router
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelectedRouters()">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0" id="routers-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllRouters"></th>
                                <th>Name</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="routers-tbody">
                            <!-- JS will populate -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Router Details Section (Ports & Routes) -->
        <div id="section-router-details" style="display: none;">
            <div class="page-header">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm me-3" onclick="showSection('routers')">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <h2 class="m-0">Router: <span id="current-router-name" class="text-warning"></span></h2>
                </div>
            </div>

            <div class="row">
                <!-- Router Ports -->
                <div class="col-lg-6 mb-4">
                    <div class="table-card h-100">
                        <div class="table-header">
                            <h5 class="m-0">Router Ports</h5>
                            <button class="btn btn-horizon-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRouterPortModal">
                                <i class="fas fa-plus"></i> Add Port
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Address</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="router-ports-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Router Static Routes -->
                <div class="col-lg-6 mb-4">
                    <div class="table-card h-100">
                        <div class="table-header">
                            <h5 class="m-0">Static Routes</h5>
                            <button class="btn btn-horizon-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRouterRouteModal">
                                <i class="fas fa-plus"></i> Add Route
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Destination</th>
                                        <th>Next Hop</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="router-routes-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACL Section -->
        <div id="section-acl" style="display: none;">
            <div class="page-header">
                <h2>Network ACLs</h2>
            </div>
            <div class="alert alert-info">
                Select a switch to view and manage its Access Control Lists.
            </div>
             <div class="mb-3">
                <select class="form-select" id="aclSwitchSelect" onchange="loadAcls(this.value)">
                    <option value="">-- Select Switch --</option>
                </select>
            </div>
            <div class="table-card" id="acl-table-card" style="display:none;">
                 <div class="table-header">
                    <h5 class="m-0">ACL Rules</h5>
                    <button class="btn btn-horizon-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createAclModal">
                        <i class="fas fa-plus"></i> Add Rule
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Direction</th>
                                <th>Match</th>
                                <th>Action</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="acl-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->

    <!-- Create Switch Modal -->
    <div class="modal fade" id="createSwitchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Logical Switch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSwitchForm">
                        <div class="mb-3">
                            <label class="form-label">Switch Name</label>
                            <input type="text" class="form-control" id="switchName" required>
                            <div class="form-text">Must be unique (e.g. ls-finance)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateSwitch()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Port Modal -->
    <div class="modal fade" id="createPortModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Port</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPortForm">
                        <div class="alert alert-warning py-2 small">
                            Backend Convention: Port name will be <strong>&lt;switch&gt;-port&lt;number&gt;</strong>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Port Number</label>
                            <input type="text" class="form-control" id="portNum" placeholder="e.g. 1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">MAC Address</label>
                            <input type="text" class="form-control" id="portMac" placeholder="00:00:00:00:00:01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">IP Address</label>
                            <input type="text" class="form-control" id="portIp" placeholder="192.168.1.10" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreatePort()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configure VLAN Modal -->
    <div class="modal fade" id="configPortModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure Port VLAN</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="configPortNum">
                    <p class="text-muted">Configure Access VLAN for <strong id="configPortNameDisplay"></strong>.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">VLAN Tag</label>
                        <input type="number" class="form-control" id="vlanTag" placeholder="1-4095">
                        <div class="form-text">Setting a tag will make this an Access port.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitConfigVlan()">Set VLAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create ACL Modal -->
    <div class="modal fade" id="createAclModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add ACL Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAclForm">
                        <div class="row g-3">
                            <!-- Policy -->
                            <div class="col-md-6">
                                <label class="form-label">Direction</label>
                                <select class="form-select" id="aclDirection">
                                    <option value="to">To Lport (Ingress)</option>
                                    <option value="from">From Lport (Egress)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Priority</label>
                                <input type="number" class="form-control" id="aclPriority" value="1001" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Action</label>
                                <select class="form-select" id="aclAction">
                                    <option value="allow">Allow</option>
                                    <option value="allow-related">Allow Related</option>
                                    <option value="drop">Drop</option>
                                    <option value="reject">Reject</option>
                                    <option value="allow-stateless">Allow Stateless</option>
                                </select>
                            </div>

                            <!-- Match Logic -->
                            <div class="col-12"><hr class="my-2"></div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Source IP</label>
                                <input type="text" class="form-control" id="aclSrcIp" placeholder="192.168.1.0/24">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Destination IP</label>
                                <input type="text" class="form-control" id="aclDstIp" placeholder="Any or IP">
                            </div>

                            <div class="col-md-5">
                                <label class="form-label">Protocol</label>
                                <select class="form-select" id="aclProtocol">
                                    <option value="">IP (Any)</option>
                                    <option value="tcp">TCP</option>
                                    <option value="udp">UDP</option>
                                    <option value="icmp4">ICMPv4</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <label class="form-label">Port / Type</label>
                                <input type="text" class="form-control" id="aclProtoDetail" placeholder="80, 443 OR Type (8)">
                                <div class="form-text small">Dest. Port or ICMP Type</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateAcl()">Add Rule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Router Modal -->
    <div class="modal fade" id="createRouterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Logical Router</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRouterForm">
                        <div class="mb-3">
                            <label class="form-label">Router Name</label>
                            <input type="text" class="form-control" id="routerName" required>
                            <div class="form-text">e.g. lr-core</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateRouter()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Router Port Modal -->
    <div class="modal fade" id="createRouterPortModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Router Port</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRouterPortForm">
                        <div class="mb-3">
                            <label class="form-label">Port Name</label>
                            <input type="text" class="form-control" id="routerPortName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">MAC Address</label>
                            <input type="text" class="form-control" id="routerPortMac" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">IP Address (CIDR)</label>
                            <input type="text" class="form-control" id="routerPortIp" placeholder="192.168.10.1/24" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateRouterPort()">Add Port</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Router Route Modal -->
    <div class="modal fade" id="createRouterRouteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Static Route</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRouterRouteForm">
                        <div class="mb-3">
                            <label class="form-label">Destination CIDR</label>
                            <input type="text" class="form-control" id="routeDestination" placeholder="0.0.0.0/0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Next Hop IP</label>
                            <input type="text" class="form-control" id="routeNextHop" placeholder="192.168.1.1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateRouterRoute()">Add Route</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- DYNAMIC API CONFIGURATION ---
        const hostname = window.location.hostname || '127.0.0.1';
        const API_BASE = `http://${hostname}:5000`;
        
        let IS_DEMO_MODE = false; 
        
        // STATE
        let currentSwitchName = null;
        let switches = [];
        let ports = {}; // Keyed by switchName

        let currentRouterName = null;
        let routers = [];
        let routerPorts = [];
        let routerRoutes = [];

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('api-target-display').textContent = API_BASE;
            
            // Initial Data Load
            showSection('overview'); 
            
            if(IS_DEMO_MODE) {
                showAlert('success', 'Demo Mode Active. Set IS_DEMO_MODE=false in code to connect to API');
            }
        });

        function toggleDemoMode() {
            IS_DEMO_MODE = !IS_DEMO_MODE;
            const status = IS_DEMO_MODE ? "Enabled" : "Disabled";
            showAlert('info', `Demo Mode ${status}. Reloading data...`);
            switches = [];
            ports = {};
            showSection('overview');
        }

        function setupEventListeners() {
            document.getElementById('selectAllSwitches').addEventListener('change', (e) => {
                const checked = e.target.checked;
                document.querySelectorAll('.switch-check').forEach(c => c.checked = checked);
            });
            document.getElementById('selectAllRouters').addEventListener('change', (e) => {
                const checked = e.target.checked;
                document.querySelectorAll('.router-check').forEach(c => c.checked = checked);
            });
        }

        function showAlert(type, message) {
            const alertArea = document.getElementById('alert-area');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertArea.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // --- API INTERACTIONS ---

        async function apiCall(endpoint, method = 'GET', body = null) {
            if (IS_DEMO_MODE) {
                return mockApi(endpoint, method, body);
            }

            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);
                
                // Handle deleting routes with slashes (CIDR)
                // Browsers usually handle encoding, but to be safe for backend path parsing
                const url = `${API_BASE}${endpoint}`;
                
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
                return await res.json();
            } catch (err) {
                console.error(err);
                if (err.name === 'TypeError' && err.message.includes('NetworkError')) {
                    showAlert('danger', `Network Error: Cannot reach ${API_BASE}. Ensure backend is running.`);
                } else if (err.message.includes('fetch')) {
                    showAlert('danger', `Connection Failed: Is the backend running at ${API_BASE}?`);
                } else {
                    showAlert('danger', `API Error: ${err.message}`);
                }
                return null;
            }
        }

        // --- OVERVIEW LOGIC ---

        async function loadOverview() {
            document.getElementById('overview-api-url').textContent = API_BASE;
            
            await fetchHealth();

            // Fetch Switches
            const data = await apiCall('/switch');
            if (data) {
                switches = data.map(name => ({ name: name }));
                document.getElementById('overview-switch-count').textContent = switches.length;
            } else {
                document.getElementById('overview-switch-count').textContent = "Err";
            }

            // Fetch Routers
            try {
                const rData = await apiCall('/router');
                if (rData) {
                     document.getElementById('overview-router-count').textContent = Array.isArray(rData) ? rData.length : "0";
                } else {
                     document.getElementById('overview-router-count').textContent = "0";
                }
            } catch (e) {
                document.getElementById('overview-router-count').textContent = "N/A";
            }
        }

        async function fetchHealth() {
            const elText = document.getElementById('health-text');
            const elDot = document.getElementById('health-indicator');
            const elDb = document.getElementById('db-name');
            
            elText.textContent = "Checking...";
            elDot.className = "status-dot";

            const res = await apiCall('/health');
            if (res && res.status === "conected") { 
                elText.textContent = "Online";
                elDot.className = "status-dot status-active";
                elText.className = "ms-2 fw-bold text-success";
                elDb.textContent = res.db;
            } else {
                elText.textContent = "Offline / Error";
                elDot.className = "status-dot status-down";
                elText.className = "ms-2 fw-bold text-danger";
                elDb.textContent = "Unknown";
            }
        }

        // --- SWITCH LOGIC ---

        async function fetchSwitches() {
            const data = await apiCall('/switch');
            if (data) {
                switches = data.map(name => ({ name: name }));
                renderSwitches();
                updateAclDropdown();
            }
        }

        async function submitCreateSwitch() {
            const name = document.getElementById('switchName').value;
            const res = await apiCall('/switch', 'POST', { name: name });
            if (res && res.status === "created") {
                switches.push({ name: name });
                renderSwitches();
                updateAclDropdown();
                bootstrap.Modal.getInstance(document.getElementById('createSwitchModal')).hide();
                document.getElementById('createSwitchForm').reset();
                showAlert('success', `Switch '${name}' created.`);
            }
        }

        async function deleteSelectedSwitches() {
            const selected = Array.from(document.querySelectorAll('.switch-check:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            if (!confirm(`Delete ${selected.length} switches?`)) return;

            for (const name of selected) {
                await apiCall(`/switch/${name}`, 'DELETE');
                switches = switches.filter(s => s.name !== name);
            }
            renderSwitches();
            updateAclDropdown();
            showAlert('success', 'Selected switches deleted.');
        }

        // --- PORT LOGIC (SWITCHES) ---

        async function loadPorts(switchName) {
            currentSwitchName = switchName;
            document.getElementById('current-switch-name').textContent = switchName;
            
            const [vlanData, portData] = await Promise.all([
                apiCall(`/switch/${switchName}/vlans`),
                apiCall(`/switch/${switchName}/ports`)
            ]);

            if (vlanData && portData) {
                const mergedMap = {};
                portData.forEach(p => {
                    mergedMap[p.name] = { ...p, vlan_tag: null, trunks: [] };
                });
                vlanData.forEach(v => {
                    if(mergedMap[v.name]) {
                        mergedMap[v.name].vlan_tag = v.vlan_tag;
                        mergedMap[v.name].trunks = v.trunks;
                    } else {
                        mergedMap[v.name] = { ...v, addresses: [] };
                    }
                });

                ports[switchName] = Object.values(mergedMap);
                renderPorts(switchName);
                showSection('ports');
            }
        }

        async function submitCreatePort() {
            const portNum = document.getElementById('portNum').value;
            const mac = document.getElementById('portMac').value;
            const ip = document.getElementById('portIp').value;
            
            const fullPortName = `${currentSwitchName}-port${portNum}`;
            const payload = { "port-name": fullPortName, "mac-address": mac, "ip": ip };

            const res = await apiCall(`/switch/${currentSwitchName}/ports`, 'POST', payload);
            if (res && res.status === "created") {
                await loadPorts(currentSwitchName);
                bootstrap.Modal.getInstance(document.getElementById('createPortModal')).hide();
                document.getElementById('createPortForm').reset();
                showAlert('success', `Port '${fullPortName}' created.`);
            }
        }

        async function deletePort(portName) {
            if (!confirm(`Delete port ${portName}?`)) return;
            const parts = portName.split('-port');
            if (parts.length < 2) return showAlert('warning', 'Port name invalid for delete.');
            const portNum = parts[1];

            await apiCall(`/switch/${currentSwitchName}/${portNum}`, 'DELETE');
            await loadPorts(currentSwitchName);
        }

        async function submitConfigVlan() {
            const portNum = document.getElementById('configPortNum').value;
            const vlanTag = document.getElementById('vlanTag').value;
            const payload = { "vlan": parseInt(vlanTag) };
            
            const res = await apiCall(`/switch/${currentSwitchName}/${portNum}/vlan`, 'POST', payload);
            if (res && res.status === "created") {
                await loadPorts(currentSwitchName);
                bootstrap.Modal.getInstance(document.getElementById('configPortModal')).hide();
                showAlert('success', 'VLAN Tag updated.');
            }
        }

        function openConfigModal(portName, currentTag) {
            const parts = portName.split('-port');
            if (parts.length < 2) return;
            const portNum = parts[1];
            document.getElementById('configPortNum').value = portNum;
            document.getElementById('configPortNameDisplay').textContent = portName;
            document.getElementById('vlanTag').value = currentTag || "";
            new bootstrap.Modal(document.getElementById('configPortModal')).show();
        }

        // --- ROUTER LOGIC ---

        async function fetchRouters() {
            const data = await apiCall('/router');
            if (data) {
                routers = data.map(name => ({ name: name }));
                renderRouters();
            }
        }

        async function submitCreateRouter() {
            const name = document.getElementById('routerName').value;
            const res = await apiCall('/router', 'POST', { name: name });
            if (res && res.status === "created") {
                routers.push({ name: name });
                renderRouters();
                bootstrap.Modal.getInstance(document.getElementById('createRouterModal')).hide();
                document.getElementById('createRouterForm').reset();
                showAlert('success', `Router '${name}' created.`);
            }
        }

        async function deleteSelectedRouters() {
            const selected = Array.from(document.querySelectorAll('.router-check:checked')).map(cb => cb.value);
            if (selected.length === 0) return;
            if (!confirm(`Delete ${selected.length} routers?`)) return;

            for (const name of selected) {
                await apiCall(`/router/${name}`, 'DELETE');
                routers = routers.filter(r => r.name !== name);
            }
            renderRouters();
            showAlert('success', 'Selected routers deleted.');
        }

        async function loadRouterDetails(routerName) {
            currentRouterName = routerName;
            document.getElementById('current-router-name').textContent = routerName;

            const [portsData, routesData] = await Promise.all([
                apiCall(`/router/${routerName}/ports`),
                apiCall(`/router/${routerName}/routes`)
            ]);

            routerPorts = portsData || [];
            routerRoutes = routesData || [];

            renderRouterDetails();
            showSection('router-details');
        }

        async function submitCreateRouterPort() {
            const name = document.getElementById('routerPortName').value;
            const mac = document.getElementById('routerPortMac').value;
            const ip = document.getElementById('routerPortIp').value;

            const payload = { "port-name": name, "mac-address": mac, "ip": ip };
            const res = await apiCall(`/router/${currentRouterName}/ports`, 'POST', payload);

            if (res && res.status === "created") {
                await loadRouterDetails(currentRouterName);
                bootstrap.Modal.getInstance(document.getElementById('createRouterPortModal')).hide();
                document.getElementById('createRouterPortForm').reset();
                showAlert('success', 'Router port added.');
            }
        }

        async function deleteRouterPort(portName) {
            if(!confirm(`Delete router port ${portName}?`)) return;
            await apiCall(`/router/${currentRouterName}/${portName}`, 'DELETE');
            await loadRouterDetails(currentRouterName);
        }

        async function submitCreateRouterRoute() {
            const dest = document.getElementById('routeDestination').value;
            const hop = document.getElementById('routeNextHop').value;

            const payload = { "destination": dest, "next-hop": hop };
            const res = await apiCall(`/router/${currentRouterName}/routes`, 'POST', payload);

            if (res && res.status === "created") {
                await loadRouterDetails(currentRouterName);
                bootstrap.Modal.getInstance(document.getElementById('createRouterRouteModal')).hide();
                document.getElementById('createRouterRouteForm').reset();
                showAlert('success', 'Static route added.');
            }
        }

        async function deleteRouterRoute(destination) {
            if(!confirm(`Delete route to ${destination}?`)) return;
            // Handle URL encoding for CIDR slashes
            const encodedDest = encodeURIComponent(destination);
            // Note: If backend expects unencoded slash, this might fail, but standard REST should handle encoded path param
            // OR the backend route <destination> will interpret 0.0.0.0/0 as two segments. 
            // Usually we rely on client encoding or backend receiving "path" type. 
            // Let's try sending encoded.
            
            await apiCall(`/router/${currentRouterName}/${destination}`, 'DELETE');
            await loadRouterDetails(currentRouterName);
        }

        // --- ACL LOGIC ---
        function updateAclDropdown() {
            const select = document.getElementById('aclSwitchSelect');
            select.innerHTML = '<option value="">-- Select Switch --</option>';
            switches.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                select.appendChild(opt);
            });
        }

        async function loadAcls(switchName) {
            if (!switchName) {
                document.getElementById('acl-table-card').style.display = 'none';
                return;
            }
            const acls = await apiCall(`/switch/${switchName}/acl`);
            const tbody = document.getElementById('acl-tbody');
            tbody.innerHTML = '';

            if (acls && acls.length > 0) {
                acls.forEach(acl => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${acl.priority}</td>
                        <td>${acl.direction}</td>
                        <td class="text-monospace small" style="word-break: break-all;">${acl.match}</td>
                        <td><span class="badge bg-${acl.action === 'allow' || acl.action.includes('related') ? 'success' : 'danger'}">${acl.action}</span></td>
                         <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAcl('${switchName}', '${acl.direction.replace('-lport','')}', '${acl.priority}', '${acl.match.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No ACLs found.</td></tr>';
            }
            document.getElementById('acl-table-card').style.display = 'block';
        }

        async function submitCreateAcl() {
            const switchName = document.getElementById('aclSwitchSelect').value;
            if(!switchName) return;

            const direction = document.getElementById('aclDirection').value;
            const priority = parseInt(document.getElementById('aclPriority').value);
            const action = document.getElementById('aclAction').value;
            const src = document.getElementById('aclSrcIp').value;
            const dst = document.getElementById('aclDstIp').value;
            const proto = document.getElementById('aclProtocol').value;
            const detail = document.getElementById('aclProtoDetail').value;

            let matchParts = [];
            if(src) matchParts.push(`ip4.src==${src}`);
            if(dst) matchParts.push(`ip4.dst==${dst}`);
            if(proto) {
                if(proto === 'icmp4') matchParts.push(detail ? `icmp4.type==${detail}` : `icmp4`);
                else if(proto === 'tcp') matchParts.push(detail ? `tcp.dst==${detail}` : `tcp`);
                else if(proto === 'udp') matchParts.push(detail ? `udp.dst==${detail}` : `udp`);
            }
            
            if(matchParts.length === 0) return showAlert('warning', 'Please specify at least one condition.');

            const payload = {
                direction: direction,
                priority: priority,
                action: action,
                match: matchParts.join(' && ')
            };

            const res = await apiCall(`/switch/${switchName}/acl`, 'POST', payload);
            if(res && res.status === "created") {
                await loadAcls(switchName);
                bootstrap.Modal.getInstance(document.getElementById('createAclModal')).hide();
                document.getElementById('createAclForm').reset();
                showAlert('success', 'ACL Rule created.');
            }
        }

        async function deleteAcl(switchName, direction, priority, match) {
            if(!confirm("Delete this ACL rule?")) return;
            const payload = { direction: direction, priority: parseInt(priority), match: match };
            const res = await apiCall(`/switch/${switchName}/acl`, 'DELETE', payload);
            if(res && res.status === "deleted") {
                 await loadAcls(switchName);
                 showAlert('success', 'ACL Rule deleted.');
            }
        }


        // --- UI RENDERING ---

        function renderSwitches() {
            const tbody = document.getElementById('switches-tbody');
            tbody.innerHTML = '';
            switches.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="switch-check" value="${s.name}"></td>
                    <td><strong>${s.name}</strong></td>
                    <td><span class="status-dot status-active"></span> Active</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadPorts('${s.name}')">Manage Ports</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPorts(switchName) {
            const tbody = document.getElementById('ports-tbody');
            tbody.innerHTML = '';
            
            const pList = ports[switchName] || [];
            if(pList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No ports found on this switch.</td></tr>';
                return;
            }

            pList.forEach(p => {
                let vlanInfo = '<span class="badge bg-secondary">Untagged</span>';
                if(p.vlan_tag) vlanInfo = `<span class="badge bg-primary">VLAN ${p.vlan_tag}</span>`;
                
                let trunkInfo = '<span class="text-muted">-</span>';
                if(p.trunks && p.trunks.length > 0) trunkInfo = `<small>${p.trunks.join(', ')}</small>`;

                let addresses = p.addresses && p.addresses.length > 0 ? p.addresses.join('<br>') : '<span class="text-muted">-</span>';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${p.name}</strong></td>
                    <td class="small font-monospace">${addresses}</td>
                    <td>${vlanInfo}</td>
                    <td>${trunkInfo}</td>
                    <td class="text-end">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="openConfigModal('${p.name}', '${p.vlan_tag || ''}')">Set VLAN</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePort('${p.name}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderRouters() {
            const tbody = document.getElementById('routers-tbody');
            tbody.innerHTML = '';
            if (routers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No routers found.</td></tr>';
                return;
            }

            routers.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="router-check" value="${r.name}"></td>
                    <td><strong>${r.name}</strong></td>
                    <td><span class="status-dot status-active"></span> Active</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-warning text-dark" onclick="loadRouterDetails('${r.name}')">Manage Router</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderRouterDetails() {
            const pBody = document.getElementById('router-ports-tbody');
            const rBody = document.getElementById('router-routes-tbody');
            pBody.innerHTML = '';
            rBody.innerHTML = '';

            // Ports
            if(routerPorts.length === 0) {
                pBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No ports.</td></tr>';
            } else {
                routerPorts.forEach(p => {
                     const addr = p.addresses && p.addresses.length > 0 ? p.addresses.join('<br>') : '-';
                     pBody.innerHTML += `
                        <tr>
                            <td>${p.name}</td>
                            <td class="small font-monospace">${addr}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRouterPort('${p.name}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                     `;
                });
            }

            // Routes
            if(routerRoutes.length === 0) {
                rBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No static routes.</td></tr>';
            } else {
                routerRoutes.forEach(r => {
                     rBody.innerHTML += `
                        <tr>
                            <td>${r.destination}</td>
                            <td>${r.next_hop}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRouterRoute('${r.destination}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                     `;
                });
            }
        }

        function showSection(section) {
            document.getElementById('section-overview').style.display = 'none';
            document.getElementById('section-switches').style.display = 'none';
            document.getElementById('section-ports').style.display = 'none';
            document.getElementById('section-routers').style.display = 'none';
            document.getElementById('section-router-details').style.display = 'none';
            document.getElementById('section-acl').style.display = 'none';
            
            document.getElementById(`section-${section}`).style.display = 'block';
            
            if (section === 'overview') loadOverview();
            else if (section === 'switches') fetchSwitches();
            else if (section === 'routers') fetchRouters();

            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            const activeLink = document.querySelector(`a[onclick*="${section}"]`);
            if(activeLink) activeLink.classList.add('active');
        }

        // --- MOCK API FOR DEMO ---
        function mockApi(endpoint, method, body) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log(`[MOCK] ${method} ${endpoint}`, body);
                    
                    if (endpoint === '/health') resolve({ "status": "conected", "db": "ovn-nb-mock" });
                    
                    // Routers Mocks
                    if (endpoint === '/router' && method === 'GET') resolve(["lr-core", "lr-edge"]);
                    if (endpoint.includes('/router/') && endpoint.includes('/ports') && method === 'GET') 
                         resolve([{name: "lr-port-1", addresses: ["00:00:00:00:01:00 192.168.10.1/24"]}]);
                    if (endpoint.includes('/router/') && endpoint.includes('/routes') && method === 'GET') 
                         resolve([{destination: "0.0.0.0/0", next_hop: "10.0.0.1"}]);

                    // Switch Mocks
                    if (endpoint === '/switch' && method === 'GET') resolve(["ls-provider", "ls-tenant-A"]);
                    
                    // Generic Writes
                    if (method === 'POST') resolve({ "status": "created", ...body });
                    if (method === 'DELETE') resolve({ "status": "deleted" });

                    // Specific reads
                    if (endpoint.includes('/vlans')) resolve([]);
                    if (endpoint.includes('/ports') && endpoint.includes('switch')) resolve([]);
                    if (endpoint.includes('/acl')) resolve([]);

                    resolve(null);
                }, 300);
            });
        }
    </script>
</body>
</html>